    // ==================== Data ====================
    let appData = {
      trip: { title: '', startDate: '', endDate: '', currency: 'EUR', budget: 0, persons: 1, notes: '' },
      tickets: [], stages: [], otherCosts: []
    };
    const currencySymbols = { 'EUR': 'â‚¬', 'CHF': 'CHF', 'USD': '$', 'GBP': 'Â£' };
    let currentMode = 'auto';
    let editingTicketIndex = null, editingStageIndex = null, editingOtherIndex = null;

    // ==================== Init ====================
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      setupListeners();
      updateUI();
    });

    function setupListeners() {
      document.querySelectorAll('.mode-fields input').forEach(el => el.addEventListener('input', calculateStageCost));
      ['tripTitle','tripStart','tripEnd','tripCurrency','tripBudget','tripPersons','tripNotes'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', () => { updateTripData(); markUnsaved(); });
      });
      document.querySelectorAll('.modal-overlay').forEach(o => {
        o.addEventListener('click', e => { if (e.target === o) closeModal(o.id); });
      });
    }

    // ==================== Storage ====================
    function loadData() {
      const saved = localStorage.getItem('reiseplanerData');
      if (saved) { try { appData = JSON.parse(saved); populateForm(); markSaved(); } catch(e) { console.error(e); } }
    }
    function saveData() { updateTripData(); localStorage.setItem('reiseplanerData', JSON.stringify(appData)); markSaved(); updateUI(); }
    function updateTripData() {
      appData.trip.title = document.getElementById('tripTitle').value;
      appData.trip.startDate = document.getElementById('tripStart').value;
      appData.trip.endDate = document.getElementById('tripEnd').value;
      appData.trip.currency = document.getElementById('tripCurrency').value;
      appData.trip.budget = parseFloat(document.getElementById('tripBudget').value) || 0;
      appData.trip.persons = parseInt(document.getElementById('tripPersons').value) || 1;
      appData.trip.notes = document.getElementById('tripNotes').value;
    }
    function populateForm() {
      document.getElementById('tripTitle').value = appData.trip.title || '';
      document.getElementById('tripStart').value = appData.trip.startDate || '';
      document.getElementById('tripEnd').value = appData.trip.endDate || '';
      document.getElementById('tripCurrency').value = appData.trip.currency || 'EUR';
      document.getElementById('tripBudget').value = appData.trip.budget || '';
      document.getElementById('tripPersons').value = appData.trip.persons || 1;
      document.getElementById('tripNotes').value = appData.trip.notes || '';
    }
    function markSaved() { document.getElementById('saveIndicator').classList.add('saved'); document.getElementById('saveStatus').textContent = 'Gespeichert'; }
    function markUnsaved() { document.getElementById('saveIndicator').classList.remove('saved'); document.getElementById('saveStatus').textContent = 'Nicht gespeichert'; }

    // ==================== Export/Import ====================
    function exportData() {
      updateTripData();
      const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = appData.trip.title ? `reise-${appData.trip.title.toLowerCase().replace(/\s+/g, '-')}.json` : 'reiseplaner.json';
      a.click();
    }
    function importData(e) {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const d = JSON.parse(ev.target.result);
          if (d.trip) { appData = d; populateForm(); saveData(); alert('âœ… Import erfolgreich!'); }
          else alert('âŒ UngÃ¼ltiges Format');
        } catch { alert('âŒ Fehler beim Import'); }
      };
      reader.readAsText(file);
      e.target.value = '';
    }
    function resetData() {
      if (confirm('âš ï¸ Alle Daten lÃ¶schen?')) {
        localStorage.removeItem('reiseplanerData');
        appData = { trip: { title: '', startDate: '', endDate: '', currency: 'EUR', budget: 0, persons: 1, notes: '' }, tickets: [], stages: [], otherCosts: [] };
        populateForm(); updateUI(); markUnsaved();
      }
    }

    // ==================== UI Updates ====================
    function updateUI() { updateKPIs(); renderTickets(); renderStages(); renderOther(); }
    function updateKPIs() {
      const sym = currencySymbols[appData.trip.currency] || 'â‚¬';
      const budget = appData.trip.budget || 0;
      const fixTotal = appData.tickets.reduce((s, t) => s + (parseFloat(t.price) || 0), 0);
      const fixPaid = appData.tickets.filter(t => t.paid).reduce((s, t) => s + (parseFloat(t.price) || 0), 0);
      const stageTotal = appData.stages.reduce((s, t) => s + (parseFloat(t.cost) || 0), 0);
      const otherTotal = appData.otherCosts.reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
      const varTotal = stageTotal + otherTotal;
      const total = fixTotal + varTotal;
      const available = budget - total;
      const pct = budget > 0 ? Math.round((total / budget) * 100) : 0;

      document.getElementById('kpiBudget').textContent = fmt(budget, sym);
      document.getElementById('kpiAvailable').textContent = fmt(available, sym);
      document.getElementById('kpiAvailable').className = 'kpi-value' + (available < 0 ? ' text-danger' : '');
      document.getElementById('kpiFixed').textContent = fmt(fixTotal, sym);
      document.getElementById('kpiFixedSub').textContent = `bezahlt: ${fmt(fixPaid, sym)}`;
      document.getElementById('kpiVar').textContent = fmt(varTotal, sym);
      document.getElementById('kpiVarSub').textContent = `Etappen ${fmt(stageTotal, sym)} Â· Sonstiges ${fmt(otherTotal, sym)}`;

      const prog = document.getElementById('budgetProgress');
      prog.style.width = Math.min(pct, 100) + '%';
      prog.className = 'progress-fill' + (pct > 100 ? ' danger' : pct > 80 ? ' warning' : '');
      document.getElementById('budgetPercent').textContent = `${pct}% verbraucht`;
    }
    function fmt(n, sym = 'â‚¬') { return `${sym}${(n || 0).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`; }
    function fmtDate(d) { return d ? new Date(d).toLocaleDateString('de-DE') : ''; }
    function esc(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

    // ==================== Cards ====================
    function toggleCard(id) { document.getElementById(id).classList.toggle('collapsed'); }

    // ==================== Modals ====================
    function openModal(id) { document.getElementById(id).classList.add('active'); document.body.style.overflow = 'hidden'; }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); document.body.style.overflow = ''; resetModal(id); }
    function resetModal(id) {
      const m = document.getElementById(id);
      m.querySelectorAll('input,textarea').forEach(el => { if (el.type === 'checkbox') el.checked = false; else if (!el.value || el.type !== 'number') el.value = ''; });
      m.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
      if (id === 'stageModal') { selectMode('auto'); document.getElementById('stageCalcCost').textContent = 'â‚¬0,00'; }
      editingTicketIndex = editingStageIndex = editingOtherIndex = null;
    }

    // ==================== Tickets ====================
    function openTicketModal(i = null) {
      editingTicketIndex = i;
      if (i !== null) {
        const t = appData.tickets[i];
        document.getElementById('ticketType').value = t.type;
        document.getElementById('ticketDesc').value = t.description;
        document.getElementById('ticketDate').value = t.date;
        document.getElementById('ticketPrice').value = t.price;
        document.getElementById('ticketPaid').checked = t.paid;
        document.getElementById('ticketNote').value = t.note || '';
      }
      openModal('ticketModal');
    }
    function saveTicket() {
      const t = {
        type: document.getElementById('ticketType').value,
        description: document.getElementById('ticketDesc').value,
        date: document.getElementById('ticketDate').value,
        price: parseFloat(document.getElementById('ticketPrice').value) || 0,
        paid: document.getElementById('ticketPaid').checked,
        note: document.getElementById('ticketNote').value
      };
      if (!t.description) { alert('Bitte Beschreibung eingeben'); return; }
      if (editingTicketIndex !== null) appData.tickets[editingTicketIndex] = t; else appData.tickets.push(t);
      closeModal('ticketModal'); saveData();
    }
    function deleteTicket(i) { if (confirm('LÃ¶schen?')) { appData.tickets.splice(i, 1); saveData(); } }
    function renderTickets() {
      const list = document.getElementById('ticketList'), empty = document.getElementById('ticketEmpty');
      const sym = currencySymbols[appData.trip.currency] || 'â‚¬';
      if (!appData.tickets.length) { list.innerHTML = ''; empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden');
      list.innerHTML = appData.tickets.map((t, i) => `
        <div class="entry-item ${t.paid ? 'paid' : ''}">
          <div class="entry-header"><span class="entry-type">${t.type}</span><span class="entry-price">${fmt(t.price, sym)}</span></div>
          <div class="entry-desc">${esc(t.description)}</div>
          <div class="entry-meta">${t.date ? fmtDate(t.date) : ''} ${t.paid ? 'âœ… Bezahlt' : 'â³ Offen'}${t.note ? ' Â· ' + esc(t.note) : ''}</div>
          <div class="entry-actions"><button class="btn btn-sm btn-ghost" onclick="openTicketModal(${i})">âœï¸ Bearbeiten</button><button class="btn btn-sm btn-danger" onclick="deleteTicket(${i})">ğŸ—‘ï¸</button></div>
        </div>`).join('');
    }

    // ==================== Stages ====================
    function openStageModal(i = null) {
      editingStageIndex = i;
      if (i !== null) {
        const s = appData.stages[i];
        document.getElementById('stageFrom').value = s.from;
        document.getElementById('stageTo').value = s.to;
        document.getElementById('stageDate').value = s.date;
        document.getElementById('stageNote').value = s.note || '';
        selectMode(s.mode);
        fillStageFields(s);
        calculateStageCost();
      }
      openModal('stageModal');
    }
    function fillStageFields(s) {
      const d = s.data || {};
      switch(s.mode) {
        case 'auto': document.getElementById('autoDistance').value = d.distance||''; document.getElementById('autoConsumption').value = d.consumption||7.5; document.getElementById('autoFuelPrice').value = d.fuelPrice||1.75; document.getElementById('autoToll').value = d.toll||''; break;
        case 'bahn': document.getElementById('bahnTicket').value = d.ticket||''; document.getElementById('bahnReservation').value = d.reservation||''; document.getElementById('bahnZubringer').value = d.zubringer||''; break;
        case 'taxi': document.getElementById('taxiDistance').value = d.distance||''; document.getElementById('taxiDuration').value = d.duration||''; document.getElementById('taxiBase').value = d.base||3.9; document.getElementById('taxiKm').value = d.km||2.2; document.getElementById('taxiWait').value = d.wait||0.6; break;
        case 'flug': document.getElementById('flugPrice').value = d.price||''; document.getElementById('flugExtras').value = d.extras||''; break;
        case 'oepnv': document.getElementById('oepnvPrice').value = d.price||''; break;
        case 'fahrrad': document.getElementById('fahrradCost').value = d.cost||''; break;
        case 'fuss': document.getElementById('fussDistance').value = d.distance||''; break;
      }
    }
    function selectMode(m) {
      currentMode = m;
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === m));
      document.querySelectorAll('.mode-fields').forEach(el => el.classList.add('hidden'));
      const map = { auto:'modeAuto', bahn:'modeBahn', taxi:'modeTaxi', flug:'modeFlug', oepnv:'modeOepnv', fahrrad:'modeFahrrad', fuss:'modeFuss' };
      document.getElementById(map[m]).classList.remove('hidden');
      calculateStageCost();
    }
    function calculateStageCost() {
      let cost = 0;
      const sym = currencySymbols[appData.trip.currency] || 'â‚¬';
      switch(currentMode) {
        case 'auto':
          const dist = parseFloat(document.getElementById('autoDistance').value)||0;
          const cons = parseFloat(document.getElementById('autoConsumption').value)||7.5;
          const fuel = parseFloat(document.getElementById('autoFuelPrice').value)||1.75;
          const toll = parseFloat(document.getElementById('autoToll').value)||0;
          cost = (dist/100)*cons*fuel + toll; break;
        case 'bahn': cost = (parseFloat(document.getElementById('bahnTicket').value)||0) + (parseFloat(document.getElementById('bahnReservation').value)||0) + (parseFloat(document.getElementById('bahnZubringer').value)||0); break;
        case 'taxi':
          const td = parseFloat(document.getElementById('taxiDistance').value)||0;
          const tm = parseFloat(document.getElementById('taxiDuration').value)||0;
          cost = (parseFloat(document.getElementById('taxiBase').value)||3.9) + td*(parseFloat(document.getElementById('taxiKm').value)||2.2) + tm*(parseFloat(document.getElementById('taxiWait').value)||0.6); break;
        case 'flug': cost = (parseFloat(document.getElementById('flugPrice').value)||0) + (parseFloat(document.getElementById('flugExtras').value)||0); break;
        case 'oepnv': cost = parseFloat(document.getElementById('oepnvPrice').value)||0; break;
        case 'fahrrad': cost = parseFloat(document.getElementById('fahrradCost').value)||0; break;
        case 'fuss': cost = 0; break;
      }
      document.getElementById('stageCalcCost').textContent = fmt(cost, sym);
      return cost;
    }
    function getStageData() {
      switch(currentMode) {
        case 'auto': return { distance: parseFloat(document.getElementById('autoDistance').value)||0, consumption: parseFloat(document.getElementById('autoConsumption').value)||7.5, fuelPrice: parseFloat(document.getElementById('autoFuelPrice').value)||1.75, toll: parseFloat(document.getElementById('autoToll').value)||0 };
        case 'bahn': return { ticket: parseFloat(document.getElementById('bahnTicket').value)||0, reservation: parseFloat(document.getElementById('bahnReservation').value)||0, zubringer: parseFloat(document.getElementById('bahnZubringer').value)||0 };
        case 'taxi': return { distance: parseFloat(document.getElementById('taxiDistance').value)||0, duration: parseFloat(document.getElementById('taxiDuration').value)||0, base: parseFloat(document.getElementById('taxiBase').value)||3.9, km: parseFloat(document.getElementById('taxiKm').value)||2.2, wait: parseFloat(document.getElementById('taxiWait').value)||0.6 };
        case 'flug': return { price: parseFloat(document.getElementById('flugPrice').value)||0, extras: parseFloat(document.getElementById('flugExtras').value)||0 };
        case 'oepnv': return { price: parseFloat(document.getElementById('oepnvPrice').value)||0 };
        case 'fahrrad': return { cost: parseFloat(document.getElementById('fahrradCost').value)||0 };
        case 'fuss': return { distance: parseFloat(document.getElementById('fussDistance').value)||0 };
        default: return {};
      }
    }
    function saveStage() {
      const from = document.getElementById('stageFrom').value, to = document.getElementById('stageTo').value;
      if (!from || !to) { alert('Bitte Start und Ziel eingeben'); return; }
      const s = { mode: currentMode, from, to, date: document.getElementById('stageDate').value, note: document.getElementById('stageNote').value, cost: calculateStageCost(), data: getStageData() };
      if (editingStageIndex !== null) appData.stages[editingStageIndex] = s; else appData.stages.push(s);
      closeModal('stageModal'); saveData();
    }
    function deleteStage(i) { if (confirm('LÃ¶schen?')) { appData.stages.splice(i, 1); saveData(); } }
    function renderStages() {
      const list = document.getElementById('stageList'), empty = document.getElementById('stageEmpty');
      const sym = currencySymbols[appData.trip.currency] || 'â‚¬';
      const icons = { auto:'ğŸš—', bahn:'ğŸš†', taxi:'ğŸš•', flug:'âœˆï¸', oepnv:'ğŸšŒ', fahrrad:'ğŸš²', fuss:'ğŸš¶' };
      const names = { auto:'Auto', bahn:'Bahn', taxi:'Taxi', flug:'Flug', oepnv:'Ã–PNV', fahrrad:'Fahrrad', fuss:'FuÃŸ' };
      if (!appData.stages.length) { list.innerHTML = ''; empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden');
      list.innerHTML = appData.stages.map((s, i) => `
        <div class="entry-item">
          <div class="entry-header"><span class="entry-type">${icons[s.mode]} ${names[s.mode]}</span><span class="entry-price">${fmt(s.cost, sym)}</span></div>
          <div class="entry-desc">${esc(s.from)} â†’ ${esc(s.to)}</div>
          <div class="entry-meta">${s.date ? fmtDate(s.date) : ''}${s.note ? ' Â· ' + esc(s.note) : ''}</div>
          <div class="entry-actions"><button class="btn btn-sm btn-ghost" onclick="openStageModal(${i})">âœï¸ Bearbeiten</button><button class="btn btn-sm btn-danger" onclick="deleteStage(${i})">ğŸ—‘ï¸</button></div>
        </div>`).join('');
    }

    // ==================== Other Costs ====================
    function openOtherModal(i = null) {
      editingOtherIndex = i;
      if (i !== null) {
        const o = appData.otherCosts[i];
        document.getElementById('otherCategory').value = o.category;
        document.getElementById('otherDesc').value = o.description;
        document.getElementById('otherDate').value = o.date;
        document.getElementById('otherAmount').value = o.amount;
        document.getElementById('otherNote').value = o.note || '';
      }
      openModal('otherModal');
    }
    function saveOther() {
      const o = { category: document.getElementById('otherCategory').value, description: document.getElementById('otherDesc').value, date: document.getElementById('otherDate').value, amount: parseFloat(document.getElementById('otherAmount').value)||0, note: document.getElementById('otherNote').value };
      if (!o.description) { alert('Bitte Beschreibung eingeben'); return; }
      if (editingOtherIndex !== null) appData.otherCosts[editingOtherIndex] = o; else appData.otherCosts.push(o);
      closeModal('otherModal'); saveData();
    }
    function deleteOther(i) { if (confirm('LÃ¶schen?')) { appData.otherCosts.splice(i, 1); saveData(); } }
    function renderOther() {
      const list = document.getElementById('otherList'), empty = document.getElementById('otherEmpty');
      const sym = currencySymbols[appData.trip.currency] || 'â‚¬';
      const icons = { Verpflegung:'ğŸ½ï¸', Parken:'ğŸ…¿ï¸', Souvenir:'ğŸ', Ã–PNV:'ğŸšŒ', Sonstiges:'ğŸ“¦' };
      if (!appData.otherCosts.length) { list.innerHTML = ''; empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden');
      list.innerHTML = appData.otherCosts.map((o, i) => `
        <div class="entry-item">
          <div class="entry-header"><span class="entry-type">${icons[o.category]||'ğŸ“¦'} ${o.category}</span><span class="entry-price">${fmt(o.amount, sym)}</span></div>
          <div class="entry-desc">${esc(o.description)}</div>
          <div class="entry-meta">${o.date ? fmtDate(o.date) : ''}${o.note ? ' Â· ' + esc(o.note) : ''}</div>
          <div class="entry-actions"><button class="btn btn-sm btn-ghost" onclick="openOtherModal(${i})">âœï¸ Bearbeiten</button><button class="btn btn-sm btn-danger" onclick="deleteOther(${i})">ğŸ—‘ï¸</button></div>
        </div>`).join('');
    }
  </script>
</body>
</html>
